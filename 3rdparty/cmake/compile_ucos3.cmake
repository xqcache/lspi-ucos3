option(USE_TEMPLATE_CFG "Use Template Configuration" ON)
option(USE_TEMPLATE_PORTS "" ON)

set(TARGET_NAME uC-OS3)
set(OS_CORE_SOURCE_DIR uC-OS3)
set(OS_CPU_SOURCE_DIR uC-CPU)
set(OS_LIB_SOURCE_DIR uC-LIB)
set(CPU_PORT_DIR "ARM-Cortex-M/ARMv7-M/ARM")

add_library(${TARGET_NAME} STATIC)
target_include_directories(${TARGET_NAME} INTERFACE "$<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/${OS_CORE_SOURCE_DIR}/Source>")
target_include_directories(${TARGET_NAME} PRIVATE "${CMAKE_CURRENT_SOURCE_DIR}/${OS_CORE_SOURCE_DIR}/Source")
target_compile_definitions(${TARGET_NAME} PUBLIC "CPU_CFG_NVIC_PRIO_BITS=4")

file(GLOB OS_CORE_SOURCES "${OS_CORE_SOURCE_DIR}/Source/*.c" "${OS_CORE_SOURCE_DIR}/Source/*.h")
target_sources(${TARGET_NAME} PRIVATE ${OS_CORE_SOURCES})

if(USE_TEMPLATE_CFG)
    file(GLOB OS_TEMPLATE_CFG_SOURCE "${OS_CORE_SOURCE_DIR}/Cfg/Template/*.h" "${OS_CORE_SOURCE_DIR}/Cfg/Template/*.c")
    target_sources(${TARGET_NAME} PRIVATE ${OS_TEMPLATE_CFG_SOURCE})
    target_include_directories(${TARGET_NAME} INTERFACE "$<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/${OS_CORE_SOURCE_DIR}/Cfg/Template>")
    target_include_directories(${TARGET_NAME} PRIVATE "${CMAKE_CURRENT_SOURCE_DIR}/${OS_CORE_SOURCE_DIR}/Cfg/Template")
endif()

if(USE_TEMPLATE_PORTS)
    file(GLOB OS_TEMPLATE_PORT_SOURCE "${OS_CORE_SOURCE_DIR}/Ports/${CPU_PORT_DIR}/*.h" "${OS_CORE_SOURCE_DIR}/Ports/${CPU_PORT_DIR}/*.c" "${OS_CORE_SOURCE_DIR}/Ports/${CPU_PORT_DIR}/*.asm")
    target_sources(${TARGET_NAME} PRIVATE ${OS_TEMPLATE_PORT_SOURCE})
    target_include_directories(${TARGET_NAME} INTERFACE "$<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/${OS_CORE_SOURCE_DIR}/Ports/${CPU_PORT_DIR}>")
    target_include_directories(${TARGET_NAME} PRIVATE "${CMAKE_CURRENT_SOURCE_DIR}/${OS_CORE_SOURCE_DIR}/Ports/${CPU_PORT_DIR}")
endif()

# uC-CPU
file(GLOB OS_CPU_SOURCES "${OS_CPU_SOURCE_DIR}/*.h" "${OS_CPU_SOURCE_DIR}/*.c" "${OS_CPU_SOURCE_DIR}/${CPU_PORT_DIR}/*.h" "${OS_CPU_SOURCE_DIR}/${CPU_PORT_DIR}/*.cpp" "${OS_CPU_SOURCE_DIR}/${CPU_PORT_DIR}/*.asm")
target_sources(${TARGET_NAME} PRIVATE ${OS_CPU_SOURCES})
target_include_directories(${TARGET_NAME} INTERFACE "$<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/${OS_CPU_SOURCE_DIR}>" "$<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/${OS_CPU_SOURCE_DIR}/${CPU_PORT_DIR}>")
target_include_directories(${TARGET_NAME} PRIVATE "${CMAKE_CURRENT_SOURCE_DIR}/${OS_CPU_SOURCE_DIR}" "${CMAKE_CURRENT_SOURCE_DIR}/${OS_CPU_SOURCE_DIR}/${CPU_PORT_DIR}")

if(USE_TEMPLATE_PORTS)
    file(GLOB OS_CPU_CFG_SOURCES "${OS_CPU_SOURCE_DIR}/Cfg/Template/*.h" "${OS_CPU_SOURCE_DIR}/Cfg/Template/*.c")
    target_sources(${TARGET_NAME} PRIVATE ${OS_CPU_CFG_SOURCES})
    target_include_directories(${TARGET_NAME} INTERFACE "$<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/${OS_CPU_SOURCE_DIR}/Cfg/Template>")
    target_include_directories(${TARGET_NAME} PRIVATE "${CMAKE_CURRENT_SOURCE_DIR}/${OS_CPU_SOURCE_DIR}/Cfg/Template")
endif()

# uC-LIB
file(GLOB OS_LIB_SOURCES "${OS_LIB_SOURCE_DIR}/*.h" "${OS_LIB_SOURCE_DIR}/*.cpp" "${OS_LIB_SOURCE_DIR}/Ports/ARM-Cortex-M4/RealView/*.asm")
target_sources(${TARGET_NAME} PRIVATE "${OS_LIB_SOURCES}")
target_include_directories(${TARGET_NAME} INTERFACE "$<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/${OS_LIB_SOURCE_DIR}>")
target_include_directories(${TARGET_NAME} PRIVATE "${CMAKE_CURRENT_SOURCE_DIR}/${OS_LIB_SOURCE_DIR}")
